import ValueIO;
import analysis::graphs::Graph;
import DataStructures;

lots of calls to toString, are treated as natives by static algorithm.

flotrLijstje = [
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/examples.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/advanced-titles.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-axis.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-bar.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-candlesticks.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-legend.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-pie.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-stacked-bars.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/click-event.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/data-download.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/extending-flotr.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/image-download.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/json-data.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/mouse-tracking.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/mouse-zoom.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/negative.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/flotr/flotr-0.2.0-alpha.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/flotr/lib/canvas2image.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/flotr/lib/canvastext.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/flotr/lib/prototype-1.6.0.2.js|
];

nonFrameworkFlotr = [
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/examples.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/advanced-titles.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-axis.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-bar.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-candlesticks.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-legend.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-pie.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/basic-stacked-bars.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/click-event.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/data-download.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/extending-flotr.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/image-download.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/json-data.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/mouse-tracking.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/mouse-zoom.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/examples/negative.js|,
	|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/flotr/flotr-0.2.0-alpha.js|
];

//pesFlotr = createCleanPessimisticCallGraph(flotrLijstje);
//optflotr = createCleanOptimisticCallGraph(flotrLijstje);

tuple[Graph[Vertex] calls, set[Vertex] escaping, set[Vertex] unresolved] pesFlotr = readBinaryValueFile(#tuple[Graph[Vertex], set[Vertex] ,set[Vertex]], |project://JavaScript%20cg%20algorithms/src/dynamicgraph/testing/snippets/flotr/pessimistic.bin|);
Graph[Vertex] optflotr = readBinaryValueFile(#Graph[Vertex], |project://JavaScript%20cg%20algorithms/src/dynamicgraph/testing/snippets/flotr/optimistic.bin|);

loc flotrCallGraph = |file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/callmapRunTogether.json|;
printStatistics(pesFlotr.calls, flotrCallGraph);
printStatistics(optflotr, flotrCallGraph);

dynFlotr = convertJsonToGraph(flotrCallGraph);
possibleIncorrectFlotr = generatePossibleIncorrectCallbackEdges(flotrLijstje);

set[str] dynamicCallees = domain(dynFlotr);
pesFlotrString = convertVertexGraphToStringGraph(pesFlotr.calls);
filteredPesFlotrString = {tup | tuple[str callee, str target] tup <- pesFlotrString, tup.callee in dynamicCallees};

pessDynDiff = filteredPesFlotrString - dynFlotr;
nonNativeDiffs = filterNativeEdges(pessDynDiff)
nativeDiff = pessDynDiff - nonNativeDiffs;

//prettyPrintGraph(nonNativeDiffs, true)

//Total missing non-native edges: size(nonNativeDiffs)
//Total missing non-native edges to prototype: size(filterTargets(nonNativeDiffs, {"prototype"}))

pesje = createCleanPessimisticCallGraph(|file:///home/sander/Dropbox/Afstuderen%20UvA/graphs/untitled/src/verwerkt/flotr/prepared/flotr/flotr-0.2.0-alpha.js|);
pesjeStr = convertVertexGraphToStringGraph(pesje.calls);

filteredDynFlotr = filterFrameworkEdgesInclusive(dynFlotr, {"flotr"})

printStatistics(pesjeStr, filteredDynFlotr);